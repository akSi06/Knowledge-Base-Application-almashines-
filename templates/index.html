<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base Search</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        .badge-source {
            font-size: 0.8em;
            margin-left: 10px;
        }

        .card-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #loadingIndicator {
            display: none;
        }

        @media (max-width: 767.98px) {
            .result-column {
                margin-bottom: 30px;
            }
        }
    </style>
</head>

<body class="container mt-5">
    <h1 class="text-center">Welcome to Knowledge Base Search</h1>
    <form id="searchForm" class="mt-4">
        <div class="form-row align-items-end">
            <div class="form-group col-md-6">
                <label for="query">Search:</label>
                <input type="text" id="query" name="query" class="form-control" placeholder="Enter your query here"
                    required>
            </div>
            <div class="form-group col-md-4">
                <label for="sortOptions">Sort By:</label>
                <select id="sortOptions" class="form-control">
                    <option value="relevance">Relevance</option>
                    <option value="score">Upvotes</option>
                    <option value="date">Date</option>
                    <option value="num_comments">Number of Answers/Comments</option>
                    <option value="source">Source</option>
                </select>
            </div>
            <div class="form-group col-md-2">
                <button type="submit" class="btn btn-primary btn-block">Search</button>
            </div>
        </div>
        <div id="loadingIndicator" class="spinner-border text-primary ml-3" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </form>

    <button id="sendEmailBtn" class="btn btn-success mt-3" style="display: none;" data-toggle="modal"
        data-target="#emailModal">Send Email</button>

    <div id="results" class="mt-5">
        <div class="row">
            <div class="col-md-6 result-column">
                <h3>Stack Overflow</h3>
                <div id="stackoverflow-results"></div>
            </div>
            <div class="col-md-6 result-column">
                <h3>Reddit</h3>
                <div id="reddit-results"></div>
            </div>
        </div>
    </div>

    <button id="loadMore" class="btn btn-secondary mt-4" style="display: none;">Load More Results</button>

    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="emailForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="emailModalLabel">Send Search Results via Email</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="recipientEmails">Recipient Email Addresses (comma-separated):</label>
                            <input type="email" class="form-control" id="recipientEmails"
                                placeholder="e.g., user1@example.com, user2@example.com" required multiple>
                            <small class="form-text text-muted">Enter one or more email addresses separated by
                                commas.</small>
                        </div>
                        <div id="emailLoadingIndicator" class="spinner-border text-primary" role="status"
                            style="display: none;">
                            <span class="sr-only">Sending...</span>
                        </div>
                        <div id="emailResponse" class="mt-2"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Email</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentQuery = '';
        let currentSort = 'relevance';
        let hasMoreResults = false;
        let redditAfterToken = null;

        let stackoverflowData = [];
        let redditData = [];

        $(document).ready(function () {
            $('#searchForm').on('submit', function (e) {
                e.preventDefault();
                currentPage = 1;
                redditAfterToken = null;
                currentQuery = $('#query').val().trim();
                currentSort = $('#sortOptions').val();
                stackoverflowData = [];
                redditData = [];
                fetchResults();
            });

            $('#sortOptions').on('change', function () {
                if (currentQuery === '') {
                    return;
                }
                currentSort = $(this).val();
                sortAndDisplayResults();
            });

            $('#loadMore').on('click', function () {
                if (hasMoreResults) {
                    currentPage += 1;
                    fetchResults();
                }
            });

            function toggleSendEmailButton() {
                if (stackoverflowData.length > 0 || redditData.length > 0) {
                    $('#sendEmailBtn').show();
                } else {
                    $('#sendEmailBtn').hide();
                }
            }

            $('#sendEmailBtn').on('click', function () {
                $('#emailForm')[0].reset();
                $('#emailResponse').empty();
            });

            $('#emailForm').on('submit', function (e) {
                e.preventDefault();
                let recipientsInput = $('#recipientEmails').val().trim();
                if (!recipientsInput) {
                    $('#emailResponse').html('<p class="text-danger">Please enter at least one email address.</p>');
                    return;
                }

                let recipientEmails = recipientsInput.split(',').map(email => email.trim()).filter(email => email !== '');
                let invalidEmails = recipientEmails.filter(email => !validateEmail(email));
                if (invalidEmails.length > 0) {
                    $('#emailResponse').html(`<p class="text-danger">Invalid email addresses: ${invalidEmails.join(', ')}</p>`);
                    return;
                }

                let emailData = {
                    recipients: recipientEmails,
                    stackoverflow: stackoverflowData,
                    reddit: redditData,
                    query: currentQuery,
                    sort_option: currentSort
                };

                $('#emailLoadingIndicator').show();
                $('#emailResponse').empty();

                $.ajax({
                    url: '/send_email',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(emailData),
                    success: function (response) {
                        $('#emailLoadingIndicator').hide();
                        $('#emailResponse').html('<p class="text-success">Email sent successfully!</p>');
                    },
                    error: function (xhr) {
                        $('#emailLoadingIndicator').hide();
                        let errorMsg = 'An error occurred while sending the email. Please try again later.';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        $('#emailResponse').html(`<p class="text-danger">${errorMsg}</p>`);
                    }
                });
            });

            function fetchResults() {
                $('#loadMore').hide();
                $('#loadingIndicator').show();

                $.ajax({
                    url: '/search',
                    type: 'GET',
                    data: {
                        query: currentQuery,
                        sort: currentSort,
                        page: currentPage,
                        after: redditAfterToken
                    },
                    success: function (data) {
                        $('#loadingIndicator').hide();

                        if (currentPage === 1) {
                            $('#stackoverflow-results').empty();
                            $('#reddit-results').empty();
                        }

                        if (data.stackoverflow && data.stackoverflow.length > 0) {
                            stackoverflowData = stackoverflowData.concat(data.stackoverflow);
                        }

                        if (data.reddit && data.reddit.length > 0) {
                            redditData = redditData.concat(data.reddit);
                        }

                        sortAndDisplayResults();
                        toggleSendEmailButton();

                        hasMoreResults = data.has_more;
                        redditAfterToken = data.reddit_after;

                        if (hasMoreResults) {
                            $('#loadMore').show();
                        } else {
                            $('#loadMore').hide();
                        }
                    },
                    error: function (xhr) {
                        $('#loadingIndicator').hide();
                        if (currentPage === 1) {
                            $('#stackoverflow-results').empty();
                            $('#reddit-results').empty();
                        }
                        let errorMsg = 'An error occurred while fetching results. Please try again later.';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        $('#stackoverflow-results').html(`<p class="text-danger">${errorMsg}</p>`);
                        $('#reddit-results').html(`<p class="text-danger">${errorMsg}</p>`);
                    }
                });
            }

            function sortAndDisplayResults() {
                displayResults('stackoverflow', stackoverflowData, '#stackoverflow-results');
                displayResults('reddit', redditData, '#reddit-results');
            }

            function displayResults(type, results, container) {
                let sortedResults = results.sort((a, b) => {
                    if (currentSort === 'date') {
                        return new Date(b.creation_date) - new Date(a.creation_date);
                    } else if (currentSort === 'score') {
                        return b.score - a.score;
                    } else if (currentSort === 'num_comments') {
                        return b.num_comments - a.num_comments;
                    } else {
                        return 0;
                    }
                });

                $(container).empty();
                sortedResults.forEach(result => {
                    let title = result.title || result.question_title || 'No title available';
                    let link = result.link || result.url;
                    let badge = '';

                    if (type === 'stackoverflow') {
                        badge = `<span class="badge badge-secondary badge-source">Stack Overflow</span>`;
                    } else if (type === 'reddit') {
                        badge = `<span class="badge badge-warning badge-source">Reddit</span>`;
                    }

                    $(container).append(`
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">${title} ${badge}</h5>
                                <p class="card-text">Score: ${result.score || 'N/A'}</p>
                                <a href="${link}" class="btn btn-primary" target="_blank">View on ${type === 'stackoverflow' ? 'Stack Overflow' : 'Reddit'}</a>
                            </div>
                        </div>
                    `);
                });
            }

            function validateEmail(email) {
                const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return re.test(String(email).toLowerCase());
            }
        });
    </script>
</body>

</html>
